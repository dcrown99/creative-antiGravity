# Auto-Clipper システム仕様書

## 1. システム概要

Auto-Clipperは、YouTube動画からハイライトを自動抽出し、魅力的なショート形式のコンテンツ（Shorts/TikTokスタイル）に変換する自動動画処理システムです。高度なAIモデルを活用し、意味解析、音声認識、コンテンツ生成を行います。

## 2. アーキテクチャ

### 2.1 コンポーネント図

```mermaid
graph TD
    User[ユーザー (Web UI)] -->|URL入力| API[FastAPI バックエンド]
    API -->|ジョブ作成| Redis[Redis キュー]
    Redis -->|タスク消費| Worker[Celery ワーカー]
    Worker -->|ダウンロード| YTDLP[yt-dlp]
    Worker -->|文字起こし| Whisper[faster-whisper]
    Worker -->|分析| Gemini[Gemini 2.5 Flash]
    Worker -->|話者分離| Pyannote[pyannote.audio]
    Worker -->|編集| MoviePy[MoviePy 1.0.3]
    Worker -->|音声合成| Voicevox[VOICEVOX]
    Worker -->|保存| Storage[ファイルシステム / GDrive]
    API -->|SSE更新| User
```

### 2.2 技術スタック

| コンポーネント | 技術 | バージョン/備考 |
|-----------|------------|--------------|
| **フロントエンド** | Next.js | 16 (App Router) |
| **UIライブラリ** | React, Shadcn UI | Tailwind CSS 4 |
| **バックエンド** | FastAPI | Python 3.13 |
| **タスクキュー** | Celery | Redis Broker |
| **データベース** | SQLite | SQLAlchemy ORM |
| **LLM** | Google Gemini | 2.5 Flash |
| **ASR (音声認識)** | faster-whisper | CUDA高速化 |
| **TTS (音声合成)** | VOICEVOX | Dockerコンテナ |
| **動画ライブラリ** | MoviePy | **1.0.3** (固定) |

## 3. コア機能

### 3.1 意味解析 & ハイライト検出
- **入力**: 全文の文字起こし（タイムスタンプ付き）。
- **処理**: Geminiが「面白い」「興味深い」「テンションが高い」瞬間を分析。
- **出力**: 候補セグメントのリスト（開始、終了、理由）。

### 3.2 スマートクロップ (縦型モード)
- **アルゴリズム**: MediaPipe (Python < 3.13) または OpenCV Haar Cascades (Python 3.13+) を使用した顔認識。
- **ロジック**:
  - フレーム内の顔を検出。
  - 現在の話者の重心を計算。
  - 話者を中心に9:16のウィンドウで切り抜き。
  - 元動画のぼかし背景を適用して空白を埋める。

### 3.3 ダイナミック字幕
- **スタイル**: 「YouTuber」スタイル（大きなフォント、縁取り、下部中央）。
- **アニメーション**: フェードイン/アウトでスムーズな切り替え。
- **話者ラベル**: 話者分離が有効な場合、話者名（例：「話者A」）を表示。

### 3.4 AIナレーション (スマート解説)
- **生成**: Geminiがクリップの内容に基づいて短く魅力的なスクリプトを生成。
- **合成**: VOICEVOX（ずんだもん、ID:3）が音声を合成。
- **パラメータ**:
  - 速度: 1.25x (ハイテンポ)
  - ピッチ: +0.05 (明るいトーン)
  - 抑揚: 1.3x (表現豊か)

### 3.5 サムネイル生成
- **フレーム選択**: フレームの明るさとコントラストを分析し、「ベスト」なフレームを選定。
- **補正**: 彩度 (1.6x) とコントラスト (1.2x) を強調。
- **テキストオーバーレイ**: AIが生成した、大きく縁取りされたタイトルを中央に追加。

### 3.6 ダイジェスト生成 (自動要約)
- **コンセプト**: 動画全体の3〜5分の要約を作成。
- **構成**:
  1. **イントロ**: 3秒間の「HIGHLIGHTS」タイトルカード。
  2. **セグメント**: トップランクのクリップをクロスフェードで結合。
  3. **タイトル**: 各セグメントにトピックを示す「テロップ」（下部3分の1）を表示。
  4. **アウトロ**: フェードアウト。

## 4. データフロー

1.  **ジョブ送信**: ユーザーがURLを送信 -> `jobs` テーブル作成 (ステータス: `pending`)。
2.  **処理**:
    - `downloading`: yt-dlpが動画を取得。
    - `transcribing`: Whisperがセグメントを生成。
    - `analyzing`: Geminiが候補を選定 -> `jobs.candidates` 更新。
    - `waiting_for_selection`: システムがユーザー入力を待機。
3.  **ユーザー選択**: ユーザーが候補とオプション（縦型、TTSなど）を選択。
4.  **レンダリング**:
    - `editing`: MoviePyが動画を処理。
    - `completed`: 結果パスを保存 -> SSE経由でユーザーに通知。

## 5. API仕様

詳細なエンドポイント定義については `apps/auto-clipper-api/README.md` を参照してください。

## 6. 今後のロードマップ

- [ ] 多言語対応 (英語/スペイン語)。
- [ ] YouTube Shorts / TikTok への直接アップロード。
- [ ] ユーザーアカウントと履歴管理。
- [ ] ローカルLLM (Gemma 2) のファインチューニング対応。
