# NOTE: This file has been sanitized for public release.
version: '3.8'

services:
  # ------------------------------
  # ------------------------------
  # 1. Infrastructure Services
  # ------------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    restart: always

  voicevox:
    image: voicevox/voicevox_engine:cpu-ubuntu20.04-latest
    container_name: voicevox
    ports:
      - "50021:50021"
    restart: unless-stopped

  # ------------------------------
  # 2. Money Master (Core DB)
  # ------------------------------
  # ------------------------------
  # 2. Money Master (Core DB)
  # ------------------------------
  money-master:
    build:
      context: .
      dockerfile: apps/money-master/Dockerfile
    container_name: money-master
    ports:
      - "3001:3000"
    env_file:
      - ./apps/money-master/.env
    environment:
      DATABASE_URL: file:./dev.db
    volumes:
      - ./apps/money-master:/app/apps/money-master
      - ./packages:/app/packages
      - ./apps/money-master/prisma:/app/apps/money-master/prisma
      - /app/node_modules
      - /app/apps/money-master/node_modules
    restart: always

  # ------------------------------
  # 3. Market Watcher (AI Analysis)
  # ------------------------------
  market-watcher:
    build:
      context: ./apps/market-watcher
      dockerfile: Dockerfile
    container_name: market-watcher
    ports:
      - "8001:8000"
    env_file:
      - ./apps/market-watcher/.env
    environment:
      - PORTFOLIO_DB_PATH=/data/dev.db
      - PORTFOLIO_PATH=/app/data/portfolio.json
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    volumes:
      - ./apps/market-watcher:/app
      - ./apps/money-master/prisma/dev.db:/data/dev.db:ro
      - ./apps/money-master/data:/app/data:ro
    depends_on:
      - money-master
      - voicevox
    restart: always

  # ------------------------------
  # 4. Auto Clipper (Video AI)
  # ------------------------------
  auto-clipper-api:
    build:
      context: ./apps/auto-clipper-api
      dockerfile: Dockerfile
    container_name: auto-clipper-api
    ports:
      - "8000:8000"
    env_file:
      - ./apps/auto-clipper-api/.env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - IMAGEMAGICK_BINARY=/usr/bin/convert
    volumes:
      - ./apps/auto-clipper-api:/app
      # ðŸ”´ TARGET: Host(Clips) -> Container(/mnt/gdrive)
      - "./data/mock_drive:/mnt/gdrive"
    restart: always
    depends_on:
      - redis

  auto-clipper-worker:
    build:
      context: ./apps/auto-clipper-api
      dockerfile: Dockerfile
    container_name: auto-clipper-worker
    command: celery -A celery_app worker --loglevel=info --concurrency=1
    env_file:
      - ./apps/auto-clipper-api/.env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - IMAGEMAGICK_BINARY=/usr/bin/convert
    volumes:
      - ./apps/auto-clipper-api:/app
      # ðŸ”´ TARGET: Host(Clips) -> Container(/mnt/gdrive)
      - "./data/mock_drive:/mnt/gdrive"
    restart: always
    depends_on:
      - redis
    # GPU Support (Uncomment if needed)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [ gpu ]

  auto-clipper-web:
    build:
      context: .
      dockerfile: apps/auto-clipper-web/Dockerfile
    container_name: auto-clipper-web
    ports:
      - "3003:3000"
    env_file:
      - ./apps/auto-clipper-web/.env
    volumes:
      - ./apps/auto-clipper-web:/app/apps/auto-clipper-web
      - ./packages:/app/packages
      - /app/packages/ui/node_modules
      - /app/packages/config/node_modules
      - /app/node_modules
      - /app/apps/auto-clipper-web/node_modules
      - /app/apps/auto-clipper-web/.next
    restart: always

  # ------------------------------
  # 5. My Kindle (Manga Reader)
  # ------------------------------
  my-kindle:
    build:
      context: .
      dockerfile: apps/my-kindle/Dockerfile
    container_name: my-kindle
    ports:
      - "3002:3000"
    env_file:
      - ./apps/my-kindle/.env
    environment:
      # ðŸ”´ UPDATED: Root of the mounted volume
      - LIBRARY_PATH=/mnt/gdrive
    volumes:
      - ./apps/my-kindle:/app/apps/my-kindle
      - ./packages:/app/packages
      - /app/packages/ui/node_modules
      - /app/packages/config/node_modules
      - /app/node_modules
      - /app/apps/my-kindle/node_modules
      - /app/apps/my-kindle/.next
      # ðŸ”´ TARGET: Host(Manga) -> Container(/mnt/gdrive)
      - "./data/mock_drive:/mnt/gdrive"
    restart: always

  # ------------------------------
  # 6. Observability Stack
  # ------------------------------
  dozzle:
    image: amir20/dozzle:latest
    container_name: log_viewer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8888:8080"
    environment:
      DOZZLE_LEVEL: info
    restart: always

